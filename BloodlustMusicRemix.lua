BloodlustMusicRemix = { };

--the hard-coded, default list of songs
--Updated Songs by Sorean-Dawnbringer
BloodlustMusicRemix.DefaultSongTable =
{
				{Title = "Kontakt - Sweet Dreams", Path = "SweetDreamsHero.mp3", Enabled = true}, --1
				{Title = "Gob - I hear you calling", Path = "GobCalling.mp3", Enabled = true}, --2
				{Title = "Papa Roach - Blood Brothers", Path = "PRBloodBrothers.mp3", Enabled = true}, --3
				{Title = "Powerman 5000 - When Worlds Collide", Path = "P5000WWC.mp3", Enabled = true}, --4
				{Title = "Pedro", Path = "pedrolust.mp3", Enabled = true}, --5
				{Title = "Lyre Le Temps - Look Like This", Path = "LLTHero.mp3", Enabled = true}, --6
				{Title = "X-men - 97 Theme", Path = "Xmen97.mp3", Enabled = true}, --7
				{Title = "Guile Theme", Path = "GuileTheme.mp3", Enabled = true}, --8
				{Title = "Rage Against The Machine - Guerrilla Radio", Path = "RATMGR.mp3", Enabled = true}, --9
				{Title = "Matrix Soundtrack - Clubbed to Death", Path = "MatrixCTD.mp3", Enabled = true}, --10
				{Title = "NiNi Music - Homeland", Path = "Nini.mp3", Enabled = true}, --11
				{Title = "Technotronic - Pump Up the Jam", Path = "TechnotronicPump.mp3", Enabled = true}, --12
				{Title = "Twisted Metal OST - Darkness Prevails", Path = "TMDarkness.mp3", Enabled = true}, --13
				{Title = "Breaking Benjamin - Polyamorous", Path = "BBPoly.mp3", Enabled = true}, --14
				{Title = "Ellie Goulding - Lights", Path = "EllieLights.mp3", Enabled = true}, --15
				{Title = "Cascada - Everytime we Touch", Path = "CascadaHero.ogg", Enabled = true}, --16
				{Title = "RA - NGGYU", Path = "RANGGYU.mp3", Enabled = true}, --17
				{Title = "Linkin Park - The Emptiness Machine", Path = "LPEmptiness.mp3", Enabled = true}, --18
				{Title = "Linkin Park - Heavy is the Crown", Path = "LPHeavy.mp3", Enabled = true}, --19
				{Title = "Eric Prydz - Call On Me", Path = "CallOnMeHero.ogg", Enabled = true}, --20
				{Title = "Pokémon - Theme Song", Path = "Pokemon.mp3", Enabled = true}, --21
				{Title = "Star Wars - Cantina Band", Path = "StarWarsCantina.mp3", Enabled = true}, --22
				{Title = "Avenge Sevenfold - Almost Easy", Path = "ASAlmostEasy.mp3", Enabled = true}, --23
				{Title = "A Day To Remember - Mr. Highway's Thinking About The End", Path = "ADTRMrHighway.mp3", Enabled = true}, --24
				{Title = "Mötley Crüe - Kickstart my Heart", Path = "KickstartHero.ogg", Enabled = true}, --25
				{Title = "Martin Garrix - Animals", Path = "MGAnimals.mp3", Enabled = true}, --26
				{Title = "Dimrain47 - Midnight Siege", Path = "DimRain47MidnightSiege.mp3", Enabled = true}, --27
				{Title = "F777 - Hydra", Path = "F777Hydra.mp3", Enabled = true}, --28
				{Title = "Michael Jackson - Thriller", Path = "MJThriller.mp3", Enabled = true}, --29
				{Title = "MF Ghost - Break Out Fire", Path = "MFGBreakOutFire.mp3", Enabled = true}, --30
				{Title = "Tom Cardy - Perception Check", Path = "TCPerception.mp3", Enabled = true}, --31
				{Title = "Holding Out for a Healer - World of Warcraft Parody", Path = "HOFH.mp3", Enabled = true}, --32
				{Title = "Zedd - Spectrum", Path = "ZeddSpectrum.mp3", Enabled = true}, --33
				{Title = "Sonic The Hedgehog - Green Hills Zone", Path = "Sonic.mp3", Enabled = true}, --34
				{Title = "Haddaway - What is love?", Path = "Haddaway.mp3", Enabled = true}, --35
				{Title = "Mortal Kombat - Main Theme", Path = "MKTheme.mp3", Enabled = true}, --36
				{Title = "Foo Fighers - Everlong", Path = "FFEverlong.mp3", Enabled = true}, --37
				{Title = "Repo! - At the Opera", Path = "PistonGoHero.mp3", Enabled = true}, --38
				{Title = "AEW - Kenny Omega (Battlecry)", Path = "AEWKennyOmega.mp3", Enabled = true}, --39
				{Title = "WWE/AEW - Cody Rhodes (Kingdom)", Path = "CRKingdom.mp3", Enabled = true}, --40
				{Title = "AEW - FTR ", Path = "AEWFTR.mp3", Enabled = true}, --41
				{Title = "AEW - Will Ospreay (Elevated)", Path = "AEWWillOspreay.mp3", Enabled = true}, --42
				{Title = "Unknown - Good Dream?", Path = "GoodDream.mp3", Enabled = true}, --43
				{Title = "WWE - Seth Rollins (Burn it down)", Path = "WWESeth.mp3", Enabled = true}, --44
				{Title = "Eminem - Lose Yourself", Path = "EminemLoseYourself.mp3", Enabled = true}, --45
				{Title = "Disturbed - Indestructible", Path = "DisturbedIndestructible.mp3", Enabled = true}, --46
				{Title = "Norwegian Recycling - Good Time", Path = "NRGoodTime.mp3", Enabled = true}, --47
				{Title = "Gareth Emery feat. Christina Novelli - Concrete Angel", Path = "ConcreteAngel.mp3", Enabled = true}, --48
				{Title = "Tiësto - Red Lights", Path = "RedLights.mp3", Enabled = true}, --49
				{Title = "Krewella - Alive", Path = "KrewellaAlive.mp3", Enabled = true}, --50
				{Title = "WWE - Randy Orton (Voices)", Path = "RKO.mp3", Enabled = true}, --51
				{Title = "Psy - Gangnam Style", Path = "PsyGangnamStyle.mp3", Enabled = true}, --52
				{Title = "State of Shock - Money Honey", Path = "SoSMoeyHoney.mp3", Enabled = true}, --53
				{Title = "Alesso - Years feat Matthew Koma", Path = "AlessoYears.mp3", Enabled = true}, --54
				{Title = "8bit Dr Horrible - On the Rise", Path = "8bitDROTR.mp3", Enabled = true}, --55
				{Title = "Avicii - Levels", Path = "Levels.mp3", Enabled = true}, --56
				{Title = "Usher - Yeah", Path = "Yeah.mp3", Enabled = true}, --57
				{Title = "SilverLetomi - I'm Still Standing", Path = "StillStanding.mp3", Enabled = true}, --58
				{Title = "The XX - Intro", Path = "Intro.mp3", Enabled = true}, --59
				{Title = "Dash Berlin - Man on the run", Path = "Run.mp3", Enabled = true}, --60
}

--the default, empty friendlist
BloodlustMusicRemix.DefaultFavoredFriendTable =
{
	{Name = "", Title = "", Path = "", Enabled = false}, --1
	{Name = "", Title = "", Path = "", Enabled = false}, --2
	{Name = "", Title = "", Path = "", Enabled = false}, --3
	{Name = "", Title = "", Path = "", Enabled = false}, --4
	{Name = "", Title = "", Path = "", Enabled = false}, --5
}

BloodlustMusicRemix.soundChannelTable = {
    "master",
    "sfx",
    "music",
    "ambience",
    "dialog"
}

BloodlustMusicRemix.soundVolumeTable = {
    "Sound_MasterVolume",
    "Sound_SFXVolume",
    "Sound_MusicVolume",
    "Sound_AmbienceVolume",
    "Sound_DialogVolume"
}

BloodlustMusicRemix.soundChannelNames = {
    "Master",
    "SFX",
    "Music",
    "Ambience",
    "Dialog"
}

BloodlustMusicRemix.soundEnabledTable = {
    "Sound_EnableAllSound",
    "Sound_EnableSFX",
    "Sound_EnableMusic",
    "Sound_EnableAmbience",
    "Sound_EnableDialog"
}

BloodlustMusicRemix.isSongPlaying = false
BloodlustMusicRemix.currentSongSpellID = 0
BloodlustMusicRemix.announcerHeader = "|cFFff2f00BloodlustMusicRemix:|r "

--Create a slash command
SLASH_BloodlustMusicRemix1, SLASH_BloodlustMusicRemix2 = '/blm', '/bloodlust';
function SlashCmdList.BloodlustMusicRemix(msg, editbox)
	Settings.OpenToCategory(BloodlustMusicRemix.category:GetID());
end

--Declaring Variables
local f = CreateFrame("Frame");
local playerGUID;
local tried = 0
local randomNumber = 0
local willPlay = 0
local defaultFilePath = "interface/addons/BloodlustMusicRemix/sounds/"
local customFilePath = "interface/addons/BloodlustMusicRemix/customsongs/"
local currentFilePath = " "
local currentlyPlaying = " "
local minute = 0
local songNumber = 0
local spellIDS = {80353, 32182, 2825, 264667, 146555, 178207, 256740, 230935, 309658, 350249, 368245, 390386, 381301, 386540, 441076}
--342242 not implemented yet

C_Timer.After(.1, function() -- wait a bit
	playerGUID = UnitGUID("player");
end)

--Checks the Unittype of a certain UnitGUID and returns the value
function GUIDcheck(guid)
	if guid then
		local unit_type = strsplit("-", guid)
		return unit_type
	end
end

--function to check whether the Hero sourceName matches a given friendName. Also tests for pets.
function FavoredFriendCheck(sourceName, sourceUnitType, friendName)
	if friendName == sourceName and sourceUnitType == "Player" then
		return true
	elseif (UnitName(friendName .. "-pet") == sourceName) and sourceUnitType == "Pet" then
		return true
	else
		return false
	end
end

--function to quickly turn COMBAT_LOG_EVENT_UNFILTERED off and on again, to prevent Hover fucking up. Bandaid fix honestly
function HoverFilter()
		f:UnregisterEvent("COMBAT_LOG_EVENT_UNFILTERED");
		C_Timer.After(.1, function()
		f:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED");
	end)
end




--Stops the song when Hero ends or is cancelled, resets variables and CVars to previous levels
function StopSong(Showtext)
	--Stops the song when Hero ends or is cancelled
	BloodlustMusicRemix.isSongPlaying = false
	BloodlustMusicRemix.currentSongSpellID = 0
	StopSound(BloodlustSoundhandle)
	SetCVar(BloodlustMusicRemix.soundVolumeTable[BloodlustSoundchannelNumber], BloodlustVolumecache)
  	SetCVar("Sound_NumChannels", BloodlustSoundchannelscache)
	if (Showtext) then
		print(BloodlustMusicRemix.announcerHeader .. "Song Stopped")
	end
end

--Repeatable function to play a song
function SongPlayerRepeatable(songIndex, friendIndex)
	local path
	local title
	local enabled
	--Checks if the song must be obtained from the Friendlist, or the normal lists and sets variables accordingly
	if (friendIndex > 0 )and (BloodlustFavoredFriendTable[friendIndex]["Enabled"]) and (BloodlustFavoredFriendTable[friendIndex]["Title"] ~= "")and (BloodlustFavoredFriendTable[friendIndex]["Path"] ~= "")then
		path = BloodlustFavoredFriendTable[friendIndex]["Path"]
		title = BloodlustFavoredFriendTable[friendIndex]["Title"]
		enabled = BloodlustFavoredFriendTable[friendIndex]["Enabled"]
	else
		path = BloodlustSongObjectTable[songIndex]["Path"]
		title = BloodlustSongObjectTable[songIndex]["Title"]
		enabled = BloodlustSongObjectTable[songIndex]["Enabled"]
	end
	--Checks if the desired song is in the default list, and sets the filepath accordingly
	currentFilePath = customFilePath
	for a, c in pairs(BloodlustMusicRemix.DefaultSongTable) do
		if c["Path"] == path then
			currentFilePath = defaultFilePath;
		end
	end

	--Preps and sets the announcement that a song is playing
	currentlyPlaying = BloodlustMusicRemix.announcerHeader ..  "Now Playing: "

    if(enabled)
    then
        currentlyPlaying = currentlyPlaying .. title
		currentFilePath = currentFilePath .. path
    else
        currentlyPlaying = currentlyPlaying .. "No Song"
		currentFilePath = currentFilePath .. "NoSong.mp3"
	end

	--(Hopefully) plays a song
	willPlay, BloodlustSoundhandle = PlaySoundFile(currentFilePath, BloodlustMusicRemix.soundChannelTable[BloodlustSoundchannelNumber])
end

--First time setup and subsequent logic to play a song
function SongPlayerPrimer(heroSpellID, specificSong, favoredFriend)
	--Checks if a song is playing, or if the addon is muted
    if (BloodlustMusicRemix.isSongPlaying) then
        print(BloodlustMusicRemix.announcerHeader .. "A song is already playing.")
    elseif(BloodlustMusicRemixMute) then
        print(BloodlustMusicRemix.announcerHeader .. "No song was selected. BloodlustMusicRemix is currently muted.")
    else

		--Resetting some variables
		tried = 0
		randomNumber = 0
		defaultFilePath = "interface/addons/BloodlustMusicRemix/sounds/"
		customFilePath = "interface/addons/BloodlustMusicRemix/customsongs/"
		currentFilePath = " "
		currentlyPlaying = " "
		local friendMessage = " "
		BloodlustVolumecache = tonumber(GetCVar(BloodlustMusicRemix.soundVolumeTable[BloodlustSoundchannelNumber]))

		--gets the current local time (minute)
		minute = (date("%M"))

		--Check if a specific song was selected, else sets the chosen song equal to the current minute. Also makes sure the number is not higher than allowed
		if specificSong > 0 then
			songNumber = specificSong
		else
			songNumber = minute + 1
		end
		if (songNumber > table.getn(BloodlustSongObjectTable)) then
			songNumber = specificSong - (table.getn(BloodlustSongObjectTable))
		end

		--primes sound values for playing
		BloodlustVolumecache = tonumber(GetCVar(BloodlustMusicRemix.soundVolumeTable[BloodlustSoundchannelNumber]))
		BloodlustSoundchannelscache = GetCVar("Sound_NumChannels")
		SetCVar(BloodlustMusicRemix.soundVolumeTable[BloodlustSoundchannelNumber], BloodlustVolumecache < BloodlustChannelVolume and BloodlustChannelVolume or BloodlustVolumecache)
		if (BloodlustMaxSoundchannelBoolean) then
 	 		SetCVar("Sound_NumChannels", 128)
		end

		--plays the song
		SongPlayerRepeatable(songNumber, favoredFriend)

		--checks if song actually played
		if(not willPlay == true) then
			--if song didn't play, a random one is selected below
			repeat
				--generates a random number
				randomNumber=math.random(1,table.getn(BloodlustSongObjectTable))

				--plays the song
				SongPlayerRepeatable(randomNumber, 0)
				tried = tried + 1

				--ends the loop if a song played or after 20 tries
			until((not willPlay == false) or (tried >= 20))
		end

		--displays the current song playing, or that it failed to play any
		if(tried >= 20) then
			BloodlustSoundhandle = 0
			StopSong(false)
  	      if(tonumber(GetCVar(BloodlustMusicRemix.soundEnabledTable[BloodlustSoundchannelNumber]))== 0) then
  	          print(BloodlustMusicRemix.announcerHeader .. "No song was selected. Your " .. BloodlustMusicRemix.soundChannelNames[BloodlustSoundchannelNumber] .. " volume channel is muted.")
  	      elseif (tonumber(GetCVar("Sound_EnableAllSound"))== 0) then
  	          print(BloodlustMusicRemix.announcerHeader .. "No song was selected. Your WoW sound is muted.")
  	      else
			    print(BloodlustMusicRemix.announcerHeader .. "No song was selected. The Addon can't find any songs, you've disabled too many or your computer's sound is muted. I think? idk man.")
  	      end
		else
			BloodlustMusicRemix.isSongPlaying = true
			BloodlustMusicRemix.currentSongSpellID = heroSpellID
			if favoredFriend > 0 and BloodlustFavoredFriendTable[favoredFriend]["Enabled"] and BloodlustFavoredFriendTable[favoredFriend]["Title"] ~= "" and BloodlustFavoredFriendTable[favoredFriend]["Path"] ~= "" then
				friendMessage = BloodlustMusicRemix.announcerHeader .. "Hero was cast by your Favored Friend: " ..  BloodlustFavoredFriendTable[favoredFriend]["Name"]
				--show a message Hero was cast by a favoredFriend
				print(friendMessage)
			end
			--if statement here shouldnt fire, will fix later
			if favoredFriend > 0  and not(BloodlustFavoredFriendTable[favoredFriend]["Enabled"]) and BloodlustFavoredFriendTable[favoredFriend]["Title"] ~= "" and BloodlustFavoredFriendTable[favoredFriend]["Path"] ~= "" then
				friendMessage = BloodlustMusicRemix.announcerHeader .. "Hero was cast by your Favored Friend: " ..  BloodlustFavoredFriendTable[favoredFriend]["Name"].. ". But the song wasn't enabled. Playing another song instead."
				print(friendMessage)
			end
			--show a message that a song is playing
			print(currentlyPlaying)
		end
	end
end


--listens for all Events, and filters out the player obtaining or removing a hero buff
function f:OnEvent()
	local _, event, _, sourceGUID, sourceName, _, _, destinationGUID, _, _, _, spellID, spellName, _, _ = CombatLogGetCurrentEventInfo();
	local favoredFriend = 0
		--if a spell is cast, and the target is the player then
		if (event == "SPELL_AURA_APPLIED" and destinationGUID == playerGUID) then
			if (spellID == 358267) then --Checks for Hover
				HoverFilter()
			end
			for key,value in pairs(spellIDS) do
				--if the buff applied was a hero buff then
				if (value == spellID) then
					--check if the person who casts the spell was in the Friendlist
					for a,c in pairs(BloodlustFavoredFriendTable) do
						if (FavoredFriendCheck(Ambiguate(sourceName, "short"), GUIDcheck(sourceGUID), c["Name"]) and BloodlustFavoredFriendTable[a]["Enabled"]) then
							favoredFriend = a;
							break
						end
					end
					--play a song
				    SongPlayerPrimer(value, 0, favoredFriend);
				end
			end
		--if a buff was removed from the player then
		elseif (event == "SPELL_AURA_REMOVED" and destinationGUID == playerGUID)
		then
			if (spellID == 358267) then --Checks for Hover
				HoverFilter()
			end
			--if the buff removed was a hero buff then
			for key,value in pairs(spellIDS) do
				if (value == spellID and value == BloodlustMusicRemix.currentSongSpellID) then
					--stop the song
					StopSong(true);
				end		
			end
		end
end
f:SetScript("OnEvent", f.OnEvent);


--Main/Options Panel
local panelWidth = 670 --SettingsPanel:GetWidth()
local panelHeight = SettingsPanel:GetHeight()
BloodlustMusicRemix.panel = CreateFrame( "Frame", "BloodlustMusicRemixPanel", UIParent, BackdropTemplateMixin and "BackdropTemplate" );
BloodlustMusicRemix.panel.name = "BloodlustMusicRemix";
BloodlustMusicRemix.panel:SetSize(panelWidth, panelHeight);
BloodlustMusicRemix.category, BloodlustMusicRemix.layout = Settings.RegisterCanvasLayoutCategory(BloodlustMusicRemix.panel, "Bloodlust Music Remix")
Settings.RegisterAddOnCategory(BloodlustMusicRemix.category);


--What to do on Login, Reload or Zoning
local Loading_EventFrame = CreateFrame("Frame")
Loading_EventFrame:RegisterEvent("PLAYER_ENTERING_WORLD")
Loading_EventFrame:SetScript("OnEvent",
	function(self, event, isInitialLogin, isReloadingUi)
		StopSong(false)
		f:UnregisterEvent("COMBAT_LOG_EVENT_UNFILTERED");
		C_Timer.After(2, function()
			f:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED");
			if BloodlustMusicRemixShowPanelAfterReload == true then
				Settings.OpenToCategory(BloodlustMusicRemix.category:GetID());
			end
			BloodlustMusicRemixShowPanelAfterReload = false
		end)
	end)

--What to do on Logout
local Logout_EventFrame = CreateFrame("Frame")
Logout_EventFrame:RegisterEvent("PLAYER_LOGOUT")
Logout_EventFrame:SetScript("OnEvent",
	function(self, event, ...)
		StopSong(false)
	end)


